<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/node_modules/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" />
    <link href="/tradeModal.css" rel="stylesheet" />
    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="tradeModal.js"></script>
    <title>Hello, world!</title>
</head>

<body>

    <button class="buy-button btn btn-success" data-id="5" data-symbol="ASHOKLEY" data-price="120" data-trade-type="buy"
        data-quantity="10">B</button>
    <button class="sell-button btn btn-danger" data-symbol="ASHOKLEY" data-price="120" data-trade-type="sell">S</button>

    <h1>Futures</h1>
    <button class="buy-button btn btn-success" data-id="3" data-symbol="ASHOKLEY" data-instrument="FUTURES"
        data-price="120" data-trade-type="buy" data-quantity="10">B</button>
    <button class="sell-button btn btn-danger" data-symbol="ASHOKLEY" data-instrument="FUTURES" data-price="120"
        data-trade-type="sell">S</button>

    <h1>Options</h1>
    <button class="buy-button btn btn-success" data-id="7" data-extra-params='{"name":"sourabh"}' data-option-type="PE"
        data-symbol="ASHOKLEY" data-expiry="28-Oct-2021" data-strike-price="16450" data-instrument="OPTIONS"
        data-price="120" data-trade-type="buy" data-quantity="10">B</button>
    <button class="sell-button btn btn-danger" data-symbol="ASHOKLEY" data-instrument="OPTIONS" data-price="120"
        data-trade-type="sell">S</button>

    <h1>Cancel Order</h1>
    <button class="cancel-order btn btn-warning" data-id="3" data-product="cnc" data-order-type="buy"
        data-instrument="EQUITY">Cancel Order (EQUITY)</button>
    <button class="cancel-order btn btn-warning" data-id="3" data-product="cnc" data-order-type="buy"
        data-instrument="FUTURES">Cancel Order (FUTURES)</button>
    <button class="cancel-order btn btn-warning" data-id="3" data-product="cnc" data-order-type="buy"
        data-instrument="OPTIONS">Cancel Order (OPTIONS)</button>


    <h1>View order details</h1>
    <button class="btn btn-success btn-show-trade-details" data-id="1" data-trade-type="buy" data-symbol="NIFTY" data-instrument="EQUITY">Show order details</button>



    <script>
        $(document).ready(function () {
            $(".cancel-order").click(function (e) {
                e.preventDefault();
                if (!confirm("Are you sure you want to cancel this order?")) {
                    return;
                }
                let obj = null;
                let instrument = $(this).attr("data-instrument");
                let action="cashOrder", subAction="cancelCashOrder";
                if (instrument == "EQUITY") {
                    obj = {
                        order_reference: $(this).attr("data-id"),
                        order_product: $(this).attr("data-product"),
                        order_flow: $(this).attr("data-order-type") == "sell" ? "S" : "B"
                    }
                } else {
                    action="foOrder";
                    subAction="cancelFOOrder";

                    obj = {
                        order_reference: $(this).attr("data-id"),
                        XCHNG_CD: "NFO",
                        PRDCT_TYP: instrument == "FUTURES" ? "F" : "O"
                    }
                }

                $.ajax({
                    url: "/icici",
                    context: $(this),
                    data: {
                        action: action,
                        subAction: subAction,
                        JSONPostData: JSON.stringify(obj)
                    },
                    method: "post",
                    complete: function () {
                    },
                    success: function (data) {
                        console.log(data);
                        if (data.Status != "200") {
                            if (data.Status == "tc-401") {
                                alert("You're not authorised to perform this request. Please login and come back to this page. We're not redirecting you to the login page.");
                                window.location.href = "/?pageView=iciciLogin";
                                return;
                            }
                            else {
                                alert(data.Error||data.Success.message);
                            }
                            return;
                        }
                        alert("Successfully cancelled order.");
                        $(this).prop("disabled", true);
                    }
                });

            });

            $(".btn-show-trade-details").tradeDetailsModal();

            $(".buy-button, .sell-button").tradeModal({
                product:"mis",
                onSubmit: function (data, extraParams) {
                    console.log(data);
                    console.log(extraParams);
                    if (!extraParams) {
                        extraParams = {};
                    }
                    let action = "cashOrder", subAction = "placeCashOrder";

                    $(this).tradeModal("loading", true);
                    let obj = {};

                    if (data.instrument == "EQUITY") {
                        if (data.id) {
                            subAction = "modifyCashOrder";
                            obj = {
                                ...extraParams,
                                order_reference: data.id,
                                new_order_qty: data.quantity,
                                new_order_rate: data.order == "market" || data.order == "slm" ? 0 : data.price,
                                new_order_stp_loss_price: data.order=="market"||data.order=="limit"?0:data.stoploss,
                                new_order_disclosed_qty: data.discQuantity,
                                new_ord_typ: data.order == "market"||data.order == "slm" ? "M" : "L",
                                new_order_validity: data.validity == "day" ? "T" : "I",
                            }
                        } else {
                            obj = {
                                order_stock_cd: data.symbol,
                                order_xchng_cd: "NSE",
                                order_product: data.product == "cnc" ? "CASH" : "MARGIN",
                                order_type: data.order == "market" || data.order == "slm" ? "M" : "L",
                                order_validity: data.validity == "day" ? "T" : "I",
                                order_quantity: data.quantity,
                                order_rate: data.order == "market"||data.order=="slm" ? 0 : data.price,
                                order_flow: data.tradeType == "buy" ? "B" : "S",
                                order_stp_loss_price: data.order=="market"||data.order=="limit"?0:data.stoploss,
                                order_disclosed_qty: data.discQuantity
                            };
                        }
                    } else if (data.instrument == "FUTURES") {
                        action = "foOrder", subAction = "placeFOOrder";
                        if (data.id) {
                            subAction = "modifyFOOrder";
                            obj = {
                                ...extraParams,
                                order_reference: data.id,
                                new_order_type: data.order == "market" || data.order == "slm" ? "M" : "L",
                                new_order_validity: data.validity == "day" ? "T" : "I",
                                new_order_quantity: data.quantity,
                                new_order_rate: data.order=="market"||data.order=="slm" ? 0 : (data.price * 100),
                                new_order_stp_loss_price: data.order=="market"||data.order=="limit"?0:data.stoploss,
                                new_order_disclosed_qty: data.discQuantity,
                                prdct_typ: "F",
                                undrlyng: data.fnoSymbol,
                                expry_dt: data.expiry,
                                order_opt_exer_type: "*E",
                                strk_prc: 0,
                                BNK_TRN_TYP: "Y",
                            }
                        } else {
                            obj = {
                                order_stock_cd: data.fnoSymbol,
                                order_xchng_cd: "NFO",
                                order_product: "F",
                                order_exp_date: data.expiry,
                                order_strike_price: data.strikePrice * 100,
                                order_type: data.order=="market"||data.order=="slm" ? "M" : "L",
                                order_quantity: data.lotSize * data.noOfLots,
                                order_rate: data.order == "market" ? 0 : (data.price * 100),
                                order_flow: data.tradeType == "buy" ? "B" : "S",
                                order_stp_loss_price: data.order=="market"||data.order=="limit"?0:data.stoploss,
                                order_disclosed_qty: data.discQuantity,
                                order_opt_exer_type: "*E",
                                order_validity: "T",
                                order_ctgry_indstk: data.indstk
                            };
                        }
                    } else if (data.instrument == "OPTIONS") {
                        action = "foOrder", subAction = "placeFOOrder"
                        if (data.id) {
                            subAction = "modifyFOOrder";
                            obj = {
                                ...extraParams,
                                order_reference: data.id,
                                new_order_type: data.order == "market"||data.order=="slm" ? "M" : "L",
                                new_order_validity: data.validity == "day" ? "T" : "I",
                                new_order_quantity: data.quantity,
                                new_order_rate: data.order == "market"||data.order=="slm" ? 0 : (data.price * 100),
                                new_order_stp_loss_price: data.order=="market"||data.order=="limit"?0:data.stoploss,
                                new_order_disclosed_qty: data.discQuantity,
                                prdct_typ: "O",
                                undrlyng: data.fnoSymbol,
                                expry_dt: data.expiry,
                                order_opt_exer_type: data.optionType,
                                strk_prc: data.strikePrice * 100,
                                BNK_TRN_TYP: "Y"
                            }
                        } else {
                            obj = {
                                order_stock_cd: data.fnoSymbol,
                                order_xchng_cd: "NFO",
                                order_product: "O",
                                order_exp_date: data.expiry,
                                order_strike_price: data.strikePrice * 100,
                                order_type: data.order == "market"||data.order=="slm" ? "M" : "L",
                                order_quantity: data.lotSize * data.noOfLots,
                                order_rate: data.order == "market"||data.order=="slm" ? 0 : (data.price * 100),
                                order_flow: data.tradeType == "buy" ? "B" : "S",
                                order_stp_loss_price: data.order=="market"||data.order=="limit"?0:data.stoploss,
                                order_disclosed_qty: data.discQuantity,
                                order_opt_exer_type: data.optionType,
                                order_validity: "T",
                                order_ctgry_indstk: data.indstk
                            };
                        }
                    }

                    console.log("Converted object: ", obj);

                    $.ajax({
                        url: "/icici",
                        context: $(this),
                        data: {
                            action: action,
                            subAction: subAction,
                            JSONPostData: JSON.stringify(obj)
                        },
                        method: "post",
                        complete: function () {
                            $(this).tradeModal("loading", false);
                        },
                        success: function (data) {
                            console.log(data);
                            if (data.Status != "200") {
                                if (data.Status == "401") {
                                    alert("You're not authorised to perform this request. Please login and come back to this page. We're not redirecting you to the login page.");
                                    window.location.href = "/?pageView=iciciLogin";
                                    return;
                                }
                                else {
                                    $(this).tradeModal('error', data.Error);
                                }
                                return;
                            }

                            $(this).tradeModal("success", 'Successfully placed order.');
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>