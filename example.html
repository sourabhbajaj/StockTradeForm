<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/node_modules/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" />
    <link href="/tradeModal.css" rel="stylesheet" />
    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="tradeModal.js"></script>
    <title>Hello, world!</title>
</head>

<body>

    <button class="buy-button btn btn-success" data-id="5" data-symbol="ASHOKLEY" data-price="120" data-trade-type="buy"
        data-quantity="10">B</button>
    <button class="sell-button btn btn-danger" data-symbol="ASHOKLEY" data-price="120" data-trade-type="sell">S</button>

    <h1>Futures</h1>
    <button class="buy-button btn btn-success" data-id="3" data-symbol="ASHOKLEY" data-instrument="FUTURES" data-price="120"
        data-trade-type="buy" data-quantity="10">B</button>
    <button class="sell-button btn btn-danger" data-symbol="ASHOKLEY" data-instrument="FUTURES" data-price="120"
        data-trade-type="sell">S</button>

    <h1>Options</h1>
    <button class="buy-button btn btn-success" data-id="7" data-extra-params="" data-option-type="PE" data-symbol="ASHOKLEY" data-expiry="28-Oct-2021" data-strike-price="16750" data-instrument="OPTIONS" data-price="120"
        data-trade-type="buy" data-quantity="10">B</button>
    <button class="sell-button btn btn-danger" data-symbol="ASHOKLEY" data-instrument="OPTIONS" data-price="120"
        data-trade-type="sell">S</button>

    <h1>View order details</h1>
    <button 
        class="btn btn-success btn-show-trade-details" 
        data-id="1" 
        data-symbol="ASHOKLEY" 
        data-instrument="OPTIONS" 
        data-price="120"
        data-trade-type="buy" 
        data-quantity="10"
        data-instrument="EQUITY" 
        data-exchange="NSE" 
        data-option-type="PUT" 
        data-expiry="30-Sep-2021" 
        data-strike-price="281.5" 
        data-quantity="100" 
        data-no-of-lots="2" 
        data-product="cnc" 
        data-order="market" 
        data-variety="rglr" 
        data-validity="day" 
        data-disc-quantity="0" 
        data-stoploss-trigger="110"         
        >Show order details</button>


    <div class="modal fade stock-trade-details-modal" id="stock-trade-details-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="loader hidden">
                    <svg version="1.1" id="L9" xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100"
                        enable-background="new 0 0 0 0" xml:space="preserve">
                        <path fill="#666"
                            d="M73,50c0-12.7-10.3-23-23-23S27,37.3,27,50 M30.9,50c0-10.5,8.5-19.1,19.1-19.1S69.1,39.5,69.1,50">
                            <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="1s"
                                from="0 50 50" to="360 50 50" repeatCount="indefinite" />
                        </path>
                    </svg>
                </div>

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title stock-trade-symbol"></h4>
                    <div class="stock-trade-spot-price">Spot price: <span></span></div>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-type" class="col-sm-2 control-label">Trade Type</label>
                                    <div class="col-sm-10 stock-trade-type"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-instrument" class="col-sm-2 control-label">Instrument</label>
                                    <div class="col-sm-10 stock-trade-instrument"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-exchange"
                                        class="col-sm-2 control-label">Exchange</label>
                                    <div class="col-sm-10 stock-trade-exchange"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 stock-trade-option-type-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-option-type" class="col-sm-2 control-label">Option Type</label>
                                    <div class="col-sm-10 stock-trade-option-type"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 stock-trade-expiry-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-expiry" class="col-sm-3 control-label">Expiry Date</label>
                                    <div class="col-sm-9 stock-trade-expiry"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 stock-trade-strike-price-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-strike-price" class="col-sm-3 control-label">Strike Price</label>
                                    <div class="col-sm-9 stock-trade-strike-price"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-6 stock-trade-quantity-wrapper">
                            <div class="form-group">
                                <label for="stock-trade-quantity">Quantity</label>
                                <div class="stock-trade-quantity"></div>
                            </div>
                        </div>
                        <div class="col-xs-6 stock-trade-lots-wrapper">
                            <div class="form-group">
                                <label for="stock-trade-lots">Number of Lots</label>
                                <div class="stock-trade-lots"></div>
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div class="form-group">
                                <label for="stock-trade-price">Price</label>
                                <div class="stock-trade-price"></div>
                                <div class="stock-trade-last-traded-time"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 stock-trade-product-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-product" class="col-sm-2 control-label">Product</label>
                                    <div class="col-sm-10 stock-trade-product"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 m-t-2">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-order" class="col-sm-2 control-label">Order</label>
                                    <div class="col-sm-10 stock-trade-order"></div>
                                </div>
                            </div>
                        </div>
                        <!--
                        <div class="col-xs-12 trigger-input-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-trigger" class="col-sm-3 control-label">Trigger</label>
                                    <div class="col-sm-9">
                                        <input type="number"  min="0" step="0.01" class="form-control stock-trade-trigger" placeholder="Trigger" value="1" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        -->
                        <!-- <div class="col-xs-12 stoploss-input-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-stoploss" class="col-sm-3 control-label">Stoploss (%)</label>
                                    <div class="col-sm-9">
                                        <input type="number" step="0.01" class="form-control stock-trade-stoploss" placeholder="Stoploss" value="1" />
                                    </div>
                                </div>
                            </div>
                        </div> -->
                        <!--<div class="col-xs-12 target-input-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-product" class="col-sm-3 control-label">Target (%)</label>
                                    <div class="col-sm-9">
                                        <input type="number" step="0.01" max="100" min="0" class="form-control stock-trade-target" placeholder="Target" value="1" />
                                    </div>
                                </div>
                            </div>
                        </div>-->
                        <div class="col-xs-12 m-t-2">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-variety" class="col-sm-2 control-label">Variety</label>
                                    <div class="col-sm-10 stock-trade-variety"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 m-t-2 validity-input-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-validity" class="col-sm-2 control-label">Validity</label>
                                    <div class="col-sm-10 stock-trade-validity">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 disc-quantity-input-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-quantity" class="col-sm-3 control-label">Disc. Quantity</label>
                                    <div class="col-sm-9 stock-trade-disc-quantity">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 stoploss-trigger-input-wrapper">
                            <div class="form-group">
                                <div class="row">
                                    <label for="stock-trade-stoploss-trigger" class="col-sm-3 control-label">SL Trigger</label>
                                    <div class="col-sm-9 stock-trade-stoploss-trigger"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 text-center">
                            <div class="help-block text-red"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal" aria-label="Close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $(".btn-show-trade-details").tradeDetailsModal();

            $(".buy-button, .sell-button").tradeModal({
                onSubmit: function (data, extraParams) {
                    console.log(data);
                    console.log(extraParams);
                    if(!extraParams){
                        extraParams={};
                    }
                    let action = "cashOrder", subAction = "placeCashOrder";
                    
                    $(this).tradeModal("loading", true);
                    let obj = {};

                    if (data.instrument == "EQUITY") {
                        if(data.id){
                            subAction="modifyCashOrder";
                            obj={
                                ...extraParams,
                                order_reference: data.id,
                                new_order_qty: data.quantity,
                                new_order_rate: data.order == "market" ? 0 : data.price,
                                new_order_stp_loss_price: 0,
                                new_order_disclosed_qty: data.discQuantity,
                                new_ord_typ: data.order == "market" ? "M" : "L",                       
                                new_order_validity: data.validity == "day" ? "T" : "I",
                            }

                        }else{
                            obj = {
                                order_stock_cd: data.symbol,
                                order_xchng_cd: "NSE",
                                order_product: data.product == "cnc" ? "CASH" : "MARGIN",
                                order_type: data.order == "market" ? "M" : "L",
                                order_validity: data.validity == "day" ? "T" : "I",
                                order_quantity: data.quantity,
                                order_rate: data.order == "market" ? 0 : data.price,
                                order_flow: data.tradeType == "buy" ? "B" : "S",
                                order_stp_loss_price: 0,
                                order_disclosed_qty: data.discQuantity
                            };
                        }                        
                    } else if (data.instrument == "FUTURES") {
                        action = "foOrder", subAction = "placeFOOrder";
                        if(data.id){
                            subAction="modifyFOOrder";
                            obj={
                                ...extraParams,
                                order_reference: data.id,
                                new_ord_typ: data.order == "market" ? "M" : "L",
                                new_order_validity: data.validity == "day" ? "T" : "I",
                                new_order_quantity: data.quantity,
                                new_order_rate: data.order == "market" ? 0 : (data.price * 100),
                                new_order_stp_loss_price: 0,
                                new_order_disclosed_qty: data.discQuantity,
                                prdct_typ: "F",                                
                                undrlyng: data.fnoSymbol, 
                                expry_dt:data.expiry,
                                order_opt_exer_type: "*E",
                                strk_prc: 0,
                                BNK_TRN_TYP: "Y",
                            }
                        }else{
                            obj = {
                                order_stock_cd: data.fnoSymbol,
                                order_xchng_cd: "NFO",
                                order_product: "F",
                                order_exp_date: data.expiry,
                                order_strike_price: data.strikePrice * 100,
                                order_type: data.order == "market" ? "M" : "L",
                                order_quantity: data.lotSize * data.noOfLots,
                                order_rate: data.order == "market" ? 0 : (data.price * 100),
                                order_flow: data.tradeType == "buy" ? "B" : "S",
                                order_stp_loss_price: 0,
                                order_disclosed_qty: data.discQuantity,
                                order_opt_exer_type: "*E",
                                order_validity: "T",
                                order_ctgry_indstk: data.indstk
                            };
                        }                        
                    } else if (data.instrument == "OPTIONS") {
                        action = "foOrder", subAction = "placeFOOrder"
                        if(data.id){
                            subAction="modifyFOOrder";
                            obj={
                                ...extraParams,
                                order_reference: data.id,
                                new_ord_typ: data.order == "market" ? "M" : "L",
                                new_order_validity: data.validity == "day" ? "T" : "I",
                                new_order_quantity: data.quantity,
                                new_order_rate: data.order == "market" ? 0 : (data.price * 100),
                                new_order_stp_loss_price: 0,
                                new_order_disclosed_qty: data.discQuantity,
                                prdct_typ: "O",
                                undrlyng: data.fnoSymbol, 
                                expry_dt:data.expiry,
                                order_opt_exer_type: data.optionType,
                                strk_prc: data.strikePrice * 100,
                                BNK_TRN_TYP: "Y"
                            }
                        }else{
                            obj = {
                                order_stock_cd: data.fnoSymbol,
                                order_xchng_cd: "NFO",
                                order_product: "O",
                                order_exp_date: data.expiry,
                                order_strike_price: data.strikePrice * 100,
                                order_type: data.order == "market" ? "M" : "L",
                                order_quantity: data.lotSize * data.noOfLots,
                                order_rate: data.order == "market" ? 0 : (data.price * 100),
                                order_flow: data.tradeType == "buy" ? "B" : "S",
                                order_stp_loss_price: 0,
                                order_disclosed_qty: data.discQuantity,
                                order_opt_exer_type: data.optionType,
                                order_validity: "T",
                                order_ctgry_indstk: data.indstk
                            };
                        }                        
                    }

                    console.log(obj);

                    $.ajax({
                        url: "/icici",
                        context: $(this),
                        data: {
                            action: action,
                            subAction: subAction,
                            JSONPostData: JSON.stringify(obj)
                        },
                        method: "post",
                        complete: function () {
                            $(this).tradeModal("loading", false);
                        },
                        success: function (data) {
                            console.log(data);
                            if (data.Status != "200") {
                                if (data.Status == "401") {
                                    alert("You're not authorised to perform this request. Please login and come back to this page. We're not redirecting you to the login page.");
                                    window.location.href = "/?pageView=iciciLogin";
                                    return;
                                }
                                else {
                                    $(this).tradeModal('error', data.Error);
                                }
                                return;
                            }

                            $(this).tradeModal("success", 'Successfully placed order.');
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>